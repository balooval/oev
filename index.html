<!DOCTYPE html>
<html>
	<head>
		<title>OpenEarthViewer</title>
		<meta charset="UTF-8">
		<link rel="stylesheet" href="css/styles.css" type="text/css" />
		<script type="text/javascript" src="js/libs/three.js"></script>
		<script type="text/javascript" src="js/OEV.js"></script>
		<script type="text/javascript" src="js/oev/utils.js"></script>
		
		
		<script type="text/javascript" src="js/postprocessing/EffectComposer.js"></script>
		<script type="text/javascript" src="js/postprocessing/CopyShader.js"></script>
		<script type="text/javascript" src="js/postprocessing/ShaderPass.js"></script>
		<script type="text/javascript" src="js/postprocessing/RenderPass.js"></script>
		<script type="text/javascript" src="js/postprocessing/MaskPass.js"></script>
		<script type="text/javascript" src="js/postprocessing/BokehPass.js"></script>
		<script type="text/javascript" src="js/postprocessing/BokehShader.js"></script>
		<script type="text/javascript" src="js/utils/water.js"></script>
	</head>
	

<script id="vertexCloud" type="text/x-glsl-frag">
uniform float normalizedTime;
varying float vNormalizedTime;
varying float vAlpha;
varying vec2 vUv;
void main() {
	vUv = uv;
	vNormalizedTime = normalizedTime;
	vec3 normal_cameraspace = normalize(( viewMatrix * modelMatrix * vec4(normal,0.0)).xyz); 
	vec3 cameraVector = normalize(vec3(0, 0, 0) - (viewMatrix * modelMatrix * vec4(position, 1)).xyz);
	float cosTheta = dot( normal_cameraspace, cameraVector );
	cosTheta = abs(cosTheta);
	vAlpha = clamp(cosTheta - 0.5, 0.0, 1.0);
	vAlpha *= 2.0;
	gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
</script>
<script id="fragmentCloud" type="text/x-glsl-frag">
uniform sampler2D map;
varying float vNormalizedTime;
varying float vAlpha;
varying vec2 vUv;
void main() {
	vec4 pxlColor = texture2D(map, vUv);
	vec3 color = vec3(vNormalizedTime);
	float morning = smoothstep(0.24, 0.3, vNormalizedTime);
	float clampedAlpha = clamp(pxlColor.a, 0.5, 0.9);
	float night = smoothstep(0.71, 0.75, vNormalizedTime) * 0.9;
	float red = (1.0 - clampedAlpha) * morning;
	red *= abs(smoothstep(0.74, 0.76, vNormalizedTime) - 1.0);
	color.r = 0.1 + morning - night + red * 2.0;
	color.g = 0.1 + morning - night + red * 0.2;
	color.b = 0.1 + morning - night + red * 0.1;
	vec4 colFinal = vec4(color, vAlpha * pxlColor.a);
	gl_FragColor = colFinal;
}
</script>

	
<script id="vertexSun" type="text/x-glsl-frag">
uniform float sunElevation;
varying float vSunElevation;
varying float vSunColor;
void main() {
	vSunElevation = sunElevation + 0.65;
	vSunElevation = (sunElevation * 8.0) + 0.3;
	vec3 fragPos = vec3(modelMatrix * vec4(position, 1.0));
	vec3 camDir = normalize(cameraPosition - fragPos); 
	float diff = dot(normal, camDir);
	vSunColor = diff;
	gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
</script>
<script id="fragmentSun" type="text/x-glsl-frag">
varying float vSunColor;
varying float vSunElevation;
void main() {
	vec3 color = vec3(vSunColor);
	color.r = 1.0;
	color.g = (0.4 + vSunColor) * (vSunElevation + 0.1);
	color.b = (0.2 + vSunColor) * vSunElevation;
	vec4 colFinal = vec4(color, vSunColor + 0.3);
	gl_FragColor = colFinal;
}
</script>

<script id="vertexSky" type="text/x-glsl-frag">
uniform vec3 sunPos;
uniform float sunLuminosity;
uniform float skyRadius;
varying float vSunLight;
varying float vRedish;
varying float vRedishFactor;
void main() {
	vec3 sunDistance = vec3(0.0, 0.0, 0.0);
	sunDistance.x = position.x - sunPos.x;
	sunDistance.y = position.y - sunPos.y;
	sunDistance.z = position.z - sunPos.z;
	vSunLight = 2.0 - (length(sunDistance) / ((skyRadius * 4.0) * sunLuminosity));
	
	float myDistFromHorizon = abs(position.y / skyRadius);
	float sunDistToHorizon = 1.0 - abs(sunPos.y / skyRadius);
	float myDistToSun = 1.0 - abs(sunDistance.y / skyRadius);
	vRedish = myDistToSun * sunDistToHorizon;
	vRedishFactor = sunDistToHorizon * 0.7;
	gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
</script>
<script id="fragmentSky" type="text/x-glsl-frag">
varying float vSunLight;
varying float vRedish;
varying float vRedishFactor;
void main() {
	vec3 color = vec3(1.0, 1.0, 1.0);
	color.r = 0.5;
	color.g = 0.7;
	color.b = 1.0;
	color.r *= vSunLight;
	color.g *= vSunLight;
	color.b *= vSunLight;
	vec3 colorRed = vec3(0.0, 0.0, 0.0);
	colorRed.r = vRedish;
	colorRed.g = 0.5;
	colorRed.b = 0.4 + vRedish * 0.3;
	color = mix(color, colorRed, vRedishFactor);
	vec4 colFinal = vec4(color, 1.0);
	gl_FragColor = colFinal;
}
</script>
			
			
	<body onkeydown="Oev.Input.Keyboard.onKeyDown(event)" onkeyup="Oev.Input.Keyboard.onKeyUp(event)">
		<div id="modalContainer">
			<div id="modalWindow">
				<a href="#" onclick="closeModal();"><img src="img/ico_close.png" alt="close" title="close"></a>
				<div id="modalContent">
				
				</div>
			</div>
		</div>
		
		<div id="boxNotification">
		</div>
		
		
			<div id="header">OpenEarthView(er)</div>
			<div id="main">
				<div id="tools">
					<a href="standby.php">STOP</a>
					<div id="debugBox"></div>
					<div class="toolsBox">
						<h3 data-content="navigation" class="activ"><div class="ico_expend activ" id="expend_navigation"></div> Navigation</h3>
						<div class="toolsContent activ" id="toolsContent_navigation">
							<div class="heading" id="camHeading" onclick="resetHeading();"></div>
							<br>
							<input type="button" value="Zoom -" onclick="zoomOut();" title="-">
							<span id="zoom_level" style="display:inline-block;width:20px;overflow:hidden;">0</span>
							<input type="button" value="Zoom +" onclick="zoomIn();" title="+">
						</div>
					</div>
					
					<div class="toolsBox">
						<h3 data-content="datasToLoad" class="activ"><div class="ico_expend activ" id="expend_datasToLoad"></div> Datas to load</h3>
						<div class="toolsContent activ" id="toolsContent_datasToLoad">
							<input class="oev-btn-dataToLoad" type="checkbox" name="cfg_load_ele" id="cfg_load_ele" value="1"> <label for="cfg_load_ele">Elevation</label>
							<br>
							<input class="oev-btn-dataToLoad" type="checkbox" name="cfg_load_nodes" id="cfg_load_nodes" value="1"> <label for="cfg_load_nodes">Nodes</label>
							<br>
							<div id="models_switch"></div>
						</div>
					</div>	
					
					<div class="toolsBox">
						<h3 data-content="waypoints" class="activ"><div class="ico_expend activ" id="expend_waypoints"></div> Waypoints</h3>
						<br>
						<div class="btn" onclick="showWPDialog();" title="Save current location">Add waypoint</div>
						<div class="toolsContent activ" id="toolsContent_waypoints">
							<div id="waypointsInfos"></div>
						</div>
					</div>
					<div class="toolsBox">
						<h3 data-content="tools" class="activ"><div class="ico_expend activ" id="expend_tools"></div> Tools</h3>
						<div class="toolsContent activ" id="toolsContent_tools">
							<div class="btn" id="btnPlugins" onclick="openPlugins();" title="more tools">Plugins</div>
							<div class="btn" id="btnDof" onclick="OEV.switchDof();" title="switch depth of field">DOF</div>
							<div class="btn" id="btnClouds" onclick="OEV.switchClouds();" title="switch clouds">Clouds</div>
							<br>
							Sun time <input type="range" id="cfg_sun_time" min="20" max="80" step="0.1" value="50">
							<br>
							Sun luminosity <input type="range" id="cfg_sun_luminosity" min="0" max="100" step="0.1" value="50">
							<br>
							Fog Near <input type="range" id="cfg_fog_near">
							<br>
							Fog Far <input type="range" id="cfg_fog_far">
						</div>
					</div>
					<div class="toolsBox" id="config_network">
						<h3 data-content="network" class="activ"><div class="ico_expend activ" id="expend_network"></div> Network</h3>
						<div class="toolsContent activ" id="toolsContent_network">
							<div id="ws_status">
								...
							</div>
							<div id="ws_users_list">
								
							</div>
							<div id="ws_chat">
								<img src="img/ico_tchat.png" alt="tchat" title="tchat">
								<div id="ws_chat_histo">
								</div>
								<form id="ws_chat_form">
									<input type="text" id="ws_chat_msg" placeholder="enter your message" autocomplete="off"> <input type="submit" id="ws_chat_send" value="send">
								</form>
							</div>
						</div>
					</div>
					<div class="toolsBox" id="config_box">
						<h3 data-content="layers" class="activ"><div class="ico_expend activ" id="expend_layers"></div> Layer</h3>
						<div class="toolsContent activ" id="toolsContent_layers">
							<input type="radio" name="cfg_tile_layer" value="tileOsm" checked="checked"> Osm Standard
							<br>
							<input type="radio" name="cfg_tile_layer" value="tileMapbox"> Mapbox Satellite
						</div>
					</div>
				</div>
				
				<div id="threeContainer">
					<div class="overlayUI" id="overlayUICoords">
						--
					</div>
					<div class="overlayUI" id="overlayUILoading">
						<div id="computingQueue"></div>
						<div id="loading_OBJECTS"></div>
						<div id="loading_TILE2D"></div>
						<div id="loading_ELE"></div>
						<div id="loading_MODELS"></div>
						<div id="loading_BUILDINGS"></div>
						<div id="loading_SURFACE"></div>
						<div id="loading_NODES"></div>
					</div>
					<div class="overlayUI" id="overlayPlugins">
						
					</div>
					<div class="overlayUI" id="overlayMinimap">
						<div id="minimapMarkerCam"></div>
						<div id="minimapMarkerSun"></div>
					</div>
				</div>
			</div>
			<div id="footer">
				<a href="credits.html" onclick="showCredits();return false;">Credits</a> | 
				<a id="contactLink" href="mailto:toto@toto.com">Contact</a>
			</div>
		<script>
			var OEV = new OpenEarthViewer('threeContainer');
		</script>
		<script type="text/javascript" src="js/oev/ui.js"></script>
		<script type="text/javascript" src="js/oev/net/Net.js"></script>
		<script type="text/javascript" src="js/oev/net/NetTextures.js"></script>
		<script type="text/javascript" src="js/oev/net/NetModels.js"></script>
		<script type="text/javascript" src="js/oev/net/OverpassProxy.js"></script>
		<script type="text/javascript" src="js/oev/globe.js"></script>
		<script type="text/javascript" src="js/oev/tile.js"></script>
		<script type="text/javascript" src="js/oev/geo.js"></script>
		<script type="text/javascript" src="js/oev/input.js"></script>
		<script type="text/javascript" src="js/oev/dataLoader.js"></script>
		<script type="text/javascript" src="js/oev/tileBuilding.js"></script>
		<script type="text/javascript" src="js/oev/tileSurface.js"></script>
		<script type="text/javascript" src="js/oev/navigation.js"></script>
		<script type="text/javascript" src="js/oev/sky.js"></script>
		<script type="text/javascript" src="js/oev/math.js"></script>
		<script type="text/javascript" src="js/oev/animation.js"></script>
		<script type="text/javascript" src="js/oev/modelTree.js"></script>
		<script type="text/javascript" src="js/oev/geoBuild/geometryBuilder.js"></script>
		<script type="text/javascript" src="js/oev/rtt.js"></script>
		<script type="text/javascript" src="js/oev/shader.js"></script>
		<script type="text/javascript" src="js/oev/tileExtensions/water.js"></script>
		
		<script type="text/javascript" src="js/oev/tileExtensions/tileExtension.js"></script>
		<script type="text/javascript" src="js/oev/tileExtensions/nodeMesh.js"></script>
		<script type="text/javascript" src="js/oev/tileExtensions/tileExtOverpass.js"></script>
		<script type="text/javascript" src="js/oev/tileExtensions/tileExtNormal.js"></script>
		<script type="text/javascript" src="js/oev/tileExtensions/tileExtBuilding.js"></script>
		<script type="text/javascript" src="js/oev/tileExtensions/tileExtPlanes.js"></script>
		<script type="text/javascript" src="js/oev/tileExtensions/tileExtElevation.js"></script>
		<script type="text/javascript" src="js/oev/tileExtensions/tileExtLife.js"></script>
		<script type="text/javascript" src="js/oev/tileExtensions/tileExtLifeGround.js"></script>
		<script type="text/javascript" src="js/oev/tileExtensions/tileExtLifeWater.js"></script>
		<script type="text/javascript" src="js/oev/tileExtensions/tileExtLanduse.js"></script>
		<script type="text/javascript" src="js/oev/tileExtensions/tileExtDummy.js"></script>
		<script type="text/javascript" src="js/oev/tileExtensions/whale.js"></script>
		<script type="text/javascript" src="js/UI.js"></script>
		<script type="text/javascript" src="js/CamCtrl.js"></script>
		
		<script type="text/javascript" src="js/Tile3d.js"></script>
		<script type="text/javascript" src="js/TileSurface.js"></script>
		<script type="text/javascript" src="js/TileNodes.js"></script>
		<script type="text/javascript" src="js/DatasMng.js"></script>
		
		<script type="text/javascript" src="js/Earcut.js"></script>
		<script type="text/javascript" src="js/utils/lineclip.js"></script>
		<script type="text/javascript" src="js/utils/geojson-area.js"></script>
		<script type="text/javascript" src="js/plugins/GpxMng.js"></script>
		<script type="text/javascript" src="js/plugins/PlanesMng.js"></script>
		<script type="text/javascript" src="js/net/NetCtrl.js"></script>
		
		<script>
		
			OEV.init();
			
			document.getElementById("cfg_load_ele").checked = true;
			switchElevation();
			
			
			function render() {
				requestAnimationFrame( render );
				OEV.render();
			}
		</script>
	</body>
</html>