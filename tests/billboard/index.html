<!DOCTYPE html>
<html>
	<head>
		<title>Billboard</title>
		<meta charset="UTF-8">
		<script type="text/javascript" src="three.js"></script>
		<script type="text/javascript" src="orbit.js"></script>
		<script type="text/javascript" src="main.js"></script>
		<script type="text/javascript" src="rtt.js"></script>
		<script type="text/javascript" src="billboardBuffer.js"></script>
		<script type="text/javascript" src="billboard.js"></script>
	</head>
	<body>
		
<script id="fragment" type="text/x-glsl-frag">
	varying float angleToCamH;
	varying float angleToCamV;
	varying vec2 vUv;
	uniform sampler2D texture;
	uniform float tilesNbW;
	uniform float tilesNbH;
	uniform float tilePrctH;
	uniform float tilePrctV;
	void main() {
		vec2 uvOffset = vec2(0.0, 0.0);
		float tileIndexX = floor((angleToCamH / tilePrctH) + 0.5) * tilePrctH;
		float tileIndexY = floor((angleToCamV / tilePrctV) + 0.5) * tilePrctV;
		uvOffset.x = (vUv.x * tilePrctH) + tileIndexX;
		uvOffset.y = (vUv.y * tilePrctV) + tileIndexY;
		uvOffset.x = mod(uvOffset.x, 1.0);
		vec4 col = texture2D(texture, uvOffset);
		if (col.a < 0.5) {
			discard; 
		}
		gl_FragColor = col;
	}
</script>

<script id="vertexTest" type="text/x-glsl-frag">
attribute vec3 offset;
attribute vec3 offsetVertice;
varying float colDebugR;
varying float colDebugG;
varying float colDebugB;
varying float angleToCamH;
varying float angleToCamV;
varying vec2 vUv;
uniform float meshPosX;
uniform float meshPosZ;
void main() {
	float pi = 3.1415926535897932384626433832795;
	vUv = uv;
	vec3 fullPos = vec3(offset);
	fullPos.x += meshPosX * 2.0;
	fullPos.z += meshPosZ * 2.0;
	angleToCamV = 0.0;
	
	
	vec3 camLittle = vec3(cameraPosition);
	camLittle.x *= 2.0;
	camLittle.y *= 0.5;
	camLittle.z *= 2.0;
	float distToCamHor = length(camLittle-fullPos);
	float distToCamVert = abs(camLittle.y);
	angleToCamV = atan(distToCamVert, distToCamHor);
	angleToCamH = atan((cameraPosition.z * 2.0) - fullPos.z, (cameraPosition.x * 2.0) - fullPos.x);
	angleToCamH = (angleToCamH + pi) / (pi * 2.0); // normalise
	
	colDebugR = angleToCamV;
	colDebugG = angleToCamV;
	colDebugB = angleToCamV;
	

	mat4 modelView = modelViewMatrix;
	if (1 == 1){
	// First colunm.
		modelView[0][0] = 1.0; 
		modelView[0][1] = 0.0; 
		modelView[0][2] = 0.0;
	}
	if (1 == 1){
		// Second colunm.
		modelView[1][0] = 0.0; 
		modelView[1][1] = 1.0; 
		modelView[1][2] = 0.0; 
	}
	if (1 == 1){
	// Thrid colunm.
		modelView[2][0] = 0.0; 
		modelView[2][1] = 0.0; 
		modelView[2][2] = 1.0; 
	}
	vec4 tmp = vec4(offset, 1.0);
	/*
	colDebugR = (offsetVertice.x + 3.0) / 6.0;
	colDebugG = (offsetVertice.y + 3.0) / 6.0;
	colDebugB = (offsetVertice.z + 3.0) / 6.0;
	*/
	
	gl_Position = (projectionMatrix * modelViewMatrix * tmp) + (projectionMatrix * modelView * vec4(offsetVertice, 1.0));
}
</script>
<script id="fragmentDebug" type="text/x-glsl-frag">
	varying float colDebugR;
	varying float colDebugG;
	varying float colDebugB;
	varying vec2 vUv;
	uniform sampler2D texture;
	void main() {
		//gl_FragColor = texture2D(texture, vUv);
		gl_FragColor = vec4(colDebugR, colDebugG, colDebugB, 1.0);
	}
</script>



<script id="fragmentBlend" type="text/x-glsl-frag">
	varying float angleToCamH;
	varying float angleToCamV;
	varying vec2 vUv;
	uniform sampler2D texture;
	uniform float tilesNbW;
	uniform float tilesNbH;
	uniform float tilePrctH;
	uniform float tilePrctV;
	void main() {
		float colDebugR = 1.0;
		float colDebugG = 1.0;
		float colDebugB = 1.0;
		vec2 uvOffset = vec2(0.0, 0.0);
		float tileIndexX = floor((angleToCamH / tilePrctH) + 0.5) * tilePrctH; // 0 to tilesNbW (4/8/...) by steps (int)
		float tileIndexY = floor((angleToCamV / tilePrctV) + 0.5) * tilePrctV;
		uvOffset.x = (vUv.x * tilePrctH) + tileIndexX;
		uvOffset.y = (vUv.y * tilePrctV) + tileIndexY;
		uvOffset.x = mod(uvOffset.x, 1.0);
		vec4 col = texture2D(texture, uvOffset);
		
		
		//gl_FragColor = col;
		
		/*
		vec2 uvNeighbourg = vec2(uvOffset.x + tilePrctH, uvOffset.y);
		vec4 colNeighbourg = texture2D(texture, uvNeighbourg);
		vec4 colFinal = mix(col, colNeighbourg, angleToCamH - tileIndexX);
		if (colFinal.a < 0.5) {
			discard; 
		}
		gl_FragColor = colFinal;
		*/
		
		vec4 colFinal = col;
		float stepAngleH = floor((angleToCamH / tilePrctH) + 0.5) * tilePrctH;
		float prctX = ((angleToCamH + (0.5 / tilesNbW)) - stepAngleH) * tilesNbW;
		vec2 uvNeighbourg = vec2(0.0, uvOffset.y);
		if (prctX < 0.25) {
			colDebugR = 1.0;
			colDebugG = 0.0;
			colDebugB = 0.0;
			uvNeighbourg.x = uvOffset.x - tilePrctH;
			prctX = abs(prctX - 0.25) * 2.0;
		} else if (prctX < 0.75) {
			colDebugR = 0.0;
			colDebugG = 1.0;
			colDebugB = 0.0;
			uvNeighbourg.x = uvOffset.x;
		} else {
			colDebugR = 0.0;
			colDebugG = 0.0;
			colDebugB = 1.0;
			uvNeighbourg.x = uvOffset.x + tilePrctH;
			prctX = (prctX - 0.75) * 2.0;
		}
		
		vec4 colNeighbourg = texture2D(texture, uvNeighbourg);
		colFinal = mix(col, colNeighbourg, prctX);
		
		if (colFinal.a < 0.5) {
			discard; 
		}
		gl_FragColor = colFinal;
		
		
		
		//gl_FragColor = vec4(prctX, prctX, prctX, 1.0);
		
	}
</script>

<script>
	Main.init();
	Main.start();
</script>
		
	</body>
</html>